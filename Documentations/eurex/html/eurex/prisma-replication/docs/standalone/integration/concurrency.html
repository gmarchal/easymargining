<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Concurrency | Eurex Clearing PME</title>
    <link rel="shortcut icon" href="../../../../../_static/opengamma-favicon.ico"/>
    <link rel="stylesheet" href="../../../../../_static/css/main.css">
    <link rel="stylesheet" href="../../../../../_static/css/syntax.css">
    <link rel="stylesheet" href="../../../../../_static/css/alerts.css">
    <link rel="stylesheet" href="../../../../../_static/font-awesome-4.4.0/css/font-awesome.min.css">
    <script type="text/javascript" src="../../../../../_static/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/docs.js"></script>
  </head>
  <body>
    <div class="wrapper">

      <header class="top">
  <div class="row topbar">
    <h1 id="logo" class="logo">
      <a href="../../../../../index.html">Eurex Clearing PME</a>
    </h1>
    <nav>
      <!--
      <ul id="navigation" class="navigation">
        <li><a href="http://www.opengamma.com/opengamma-platform/margining">More</a></li>
      </ul>
      -->
      <div class="og">
        <div class="toggle"><button type="button" id="toggle-menu" class="button--teal">Menu</button></div>
        <div class="og_logo"><a href="http://www.opengamma.com"><img alt="OpenGamma" src="../../../../../_static/logo_topnav.png" /></a></div>
      </div>
    </nav>
  </div>
</header>

      <div id="content" class="row">

        <div id="sidebar" class="sidebar">

          <section>
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quick_start/toc.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quick_start/set_up_development_environment.html">Setting up a Development Environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/set_up_development_environment.html#system-requirements">System requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/set_up_development_environment.html#installation">Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../quick_start/run_examples.html">Running the Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/run_examples.html#calculation-of-initial-margin-for-otc-trades">Calculation of Initial Margin for OTC Trades</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/run_examples.html#calculation-of-initial-margin-for-etd-trades">Calculation of Initial Margin for ETD Trades</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/run_examples.html#calculation-of-cash-flows">Calculation of Cash Flows</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/run_examples.html#basic-api-integration-example">Basic API Integration Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/run_examples.html#running-from-the-command-line">Running from the Command Line</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../quick_start/basic_library_integration.html">Basic Library Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/basic_library_integration.html#margin-environment-lifecycle">Margin Environment Lifecycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/basic_library_integration.html#data-lifecycle">Data Lifecycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quick_start/basic_library_integration.html#third-party-libraries">Third-Party Libraries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../quick_start/advanced_library_integration.html">Advanced Library Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../overview/toc.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../common/overview/features.html">Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/overview/features.html#margin-methodologies">Margin Methodologies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/overview/features.html#product-scope">Product Scope</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/overview/features.html#outputs">Outputs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../overview/system_requirements.html">System Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../overview/system_requirements.html#software">Software</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/system_requirements.html#hardware">Hardware</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../overview/release_notes.html">Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../common/overview/known_limitations.html">Known Limitations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/overview/known_limitations.html#general">General</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/overview/known_limitations.html#etd">ETD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/overview/known_limitations.html#otc">OTC</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../overview/faq.html">Frequently Asked Questions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../overview/faq.html#system-requirements">System Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/faq.html#market-data">Market Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/faq.html#trades-and-positions">Trades and Positions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/faq.html#margin-calculation">Margin Calculation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data/toc.html">Input Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../data/trade_parsers.html">Portfolio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/trade_parsers/eurex_etd_csv.html">Eurex ETD CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/trade_parsers/eurex_otc_csv.html">Eurex OTC CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/trade_parsers/eurex_sensitivities_csv.html">Eurex Sensitivities CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/trade_parsers/fpml.html">FpML</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/trade_parsers/fixml.html">FIXML</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../common/data/eurex_market_data.html">Market Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/eurex_market_data.html#otc-requirements">OTC Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/eurex_market_data.html#etd-requirements">ETD Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/eurex_market_data.html#cross-margining-requirements">Cross-Margining Requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../common/data/fixings.html">Fixings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/fixings.html#format">Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/fixings.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../common/data/holidays.html">Holidays</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/holidays.html#format">Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/holidays.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../common/data/standard_directory_structure.html">Standard Directory Structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/standard_directory_structure.html#directory-layout">Directory Layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/data/standard_directory_structure.html#individual-file-conventions">Individual File Conventions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="toc.html">Integration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Library Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../common/api/loading_market_data.html">Loading Market Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/loading_market_data.html#automatic-file-resolution">Automatic file resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/loading_market_data.html#explicit-usage">Explicit usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/loading_market_data.html#error-handling-during-loading">Error handling during loading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../common/api/loading_portfolios.html">Loading Portfolios</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/loading_portfolios.html#error-handling-during-loading">Error handling during loading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../common/api/performing_calculations.html">Performing Calculations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/performing_calculations.html#trade-requests">Trade Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/performing_calculations.html#portfolio-requests">Portfolio Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/performing_calculations.html#add-ons">Add-ons</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/performing_calculations.html#portfolio-im">Portfolio IM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/performing_calculations.html#building-a-request">Building a request</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/performing_calculations.html#p-l-calculation-methodology">P&amp;L calculation methodology</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/performing_calculations.html#output-model">Output Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/api/performing_calculations.html#error-handling-during-calculation">Error handling during calculation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../common/overview/calculation_modes.html">Calculation Modes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../common/overview/calculation_modes.html#full-revaluation">Full Revaluation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../common/overview/calculation_modes.html#delta-approximation">Delta Approximation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="margin_results.html">Margin Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="margin_results.html#portfolio-results">Portfolio Results</a></li>
<li class="toctree-l3"><a class="reference internal" href="margin_results.html#trade-results">Trade Results</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Concurrency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cpu-utilization">CPU utilization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#custom-executor-service">Custom Executor Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="#concurrent-use-of-the-api">Concurrent use of the API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="common_tasks.html">Common Tasks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="common_tasks.html#what-if-analysis">What-If Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="common_tasks.html#multiple-days-of-market-data">Multiple Days of Market Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="common_tasks.html#log-configuration">Log Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../advanced/toc.html">Advanced Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../advanced/trade_model.html">Trade Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../advanced/third_party_dependencies.html">Third-Party Dependencies</a></li>
</ul>
</li>
</ul>

            
          </section>
        </div>

        <main id="main" class="main">
          
  <div class="section" id="concurrency">
<span id="id1"></span><h1>Concurrency</h1>
<div class="section" id="cpu-utilization">
<h2>CPU utilization</h2>
<p>The Eurex Clearing PME is designed to maximize use of the host machine&#8217;s available CPU cores.
The underlying OpenGamma technology employed in the PME has been designed
to run risk calculations for large portfolios in a parallel manner.</p>
<p>When performing VaR calculations by full revaluation (rather than a sensitivity-based approximation),
the underlying risk engine is used to calculate Present Value under each CCP scenario. These results are then consumed
by the PME in an asynchronous manner, minimizing the time
spent on post-processing operations such as aggregation and PnL computation.
This enables initial margin calculations to scale linearly with the number of CPU cores
available.</p>
<p>By default, the library will create one thread pool per <code class="docutils literal"><span class="pre">MarginEnvironment</span></code>.
A common heuristic is used whereby the number of threads in the pool is set to the number
of available cores plus two. These are named using the string format <code class="docutils literal"><span class="pre">&quot;OG-%d&quot;</span></code> where
<code class="docutils literal"><span class="pre">%d</span></code> is an integer. All threads run in daemon mode, so will not prevent a process from terminating.</p>
<div class="align-center figure" id="id2">
<img alt="../../../../../_images/threadpool_usage.png" src="../../../../../_images/threadpool_usage.png" />
<p class="caption"><span class="caption-text">Fig 1: Eclipse debug screenshot showing the active margin calculation threads</span></p>
</div>
</div>
<div class="section" id="custom-executor-service">
<h2>Custom Executor Service</h2>
<p>The thread pool used can be customised or overridden via the <code class="docutils literal"><span class="pre">MarginEnvironmentFactory</span></code>.
When using that class to build your <code class="docutils literal"><span class="pre">MarginEnvironment</span></code>, use the <code class="docutils literal"><span class="pre">executorService()</span></code> method.</p>
<p>This is particularly useful in the following contexts:</p>
<ul class="simple">
<li>When your application makes use of multiple <code class="docutils literal"><span class="pre">MarginEnvironment</span></code> instances simultaneously,
by default each will allocate an <code class="docutils literal"><span class="pre">ExecutorService</span></code> that uses full CPU resources for
the machine. In this case you only want to have one and share them.</li>
<li>When your application has its own <code class="docutils literal"><span class="pre">ExecutorService</span></code> used for job dispatch and
execution, you should use that in the <code class="docutils literal"><span class="pre">MarginEnvironment</span></code> to not have contention
for resources between your application&#8217;s computational jobs and the <code class="docutils literal"><span class="pre">MarginEnvironment</span></code>.</li>
</ul>
<p>In both of these cases it is completely acceptable and supported to share an
<code class="docutils literal"><span class="pre">ExecutorService</span></code> between multiple <code class="docutils literal"><span class="pre">MarginEnvironment</span></code> instances, or with other
tasks your application performs.</p>
<p>The following example shows how to specify a custom <code class="docutils literal"><span class="pre">ExecutorService</span></code>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">ExecutorService</span> <span class="n">myExecutorService</span> <span class="o">=</span> <span class="o">...;</span>

<span class="n">MarginEnvironment</span> <span class="n">environment</span> <span class="o">=</span>
    <span class="n">MarginEnvironmentFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="n">EurexPrismaReplication</span><span class="o">())</span>
                            <span class="o">.</span><span class="na">executorService</span><span class="o">(</span><span class="n">myExecutorService</span><span class="o">)</span>
                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="concurrent-use-of-the-api">
<h2>Concurrent use of the API</h2>
<p>The PME provides APIs for two main purposes: data loading, and executing
calculation requests.</p>
<p>Once all data has been loaded into a margin environment, then the PME
supports running multiple calculation requests against that environment
concurrently.</p>
<p>Loading data into an environment that is being used concurrently by
another thread to run calculation requests is not supported; in this case,
the modifications to the environment would need to occur while excluding
calculation requests reading from the environment, for example using a
read-write lock around calls to the APIs.</p>
</div>
</div>


        </main>
      </div>

      <footer>
  <div class="row">
    <div class="small-6 columns"><p>Version 1.8.3</p></div>
    <div class="small-6 columns"><p class="copyright">&copy; 2015 OpenGamma Limited</p></div>
  </div>
</footer>
    </div>
  </body>
</html>
