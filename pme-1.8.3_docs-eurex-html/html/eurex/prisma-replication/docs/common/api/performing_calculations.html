<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Performing Calculations | Eurex Clearing PME</title>
    <link rel="shortcut icon" href="../../../../../_static/opengamma-favicon.ico"/>
    <link rel="stylesheet" href="../../../../../_static/css/main.css">
    <link rel="stylesheet" href="../../../../../_static/css/syntax.css">
    <link rel="stylesheet" href="../../../../../_static/css/alerts.css">
    <link rel="stylesheet" href="../../../../../_static/font-awesome-4.4.0/css/font-awesome.min.css">
    <script type="text/javascript" src="../../../../../_static/js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="../../../../../_static/js/docs.js"></script>
  </head>
  <body>
    <div class="wrapper">

      <header class="top">
  <div class="row topbar">
    <h1 id="logo" class="logo">
      <a href="../../../../../index.html">Eurex Clearing PME</a>
    </h1>
    <nav>
      <!--
      <ul id="navigation" class="navigation">
        <li><a href="http://www.opengamma.com/opengamma-platform/margining">More</a></li>
      </ul>
      -->
      <div class="og">
        <div class="toggle"><button type="button" id="toggle-menu" class="button--teal">Menu</button></div>
        <div class="og_logo"><a href="http://www.opengamma.com"><img alt="OpenGamma" src="../../../../../_static/logo_topnav.png" /></a></div>
      </div>
    </nav>
  </div>
</header>

      <div id="content" class="row">

        <div id="sidebar" class="sidebar">

          <section>
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../standalone/quick_start/toc.html">Quick Start</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/quick_start/set_up_development_environment.html">Setting up a Development Environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/set_up_development_environment.html#system-requirements">System requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/set_up_development_environment.html#installation">Installation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/quick_start/run_examples.html">Running the Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/run_examples.html#calculation-of-initial-margin-for-otc-trades">Calculation of Initial Margin for OTC Trades</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/run_examples.html#calculation-of-initial-margin-for-etd-trades">Calculation of Initial Margin for ETD Trades</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/run_examples.html#calculation-of-cash-flows">Calculation of Cash Flows</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/run_examples.html#basic-api-integration-example">Basic API Integration Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/run_examples.html#running-from-the-command-line">Running from the Command Line</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/quick_start/basic_library_integration.html">Basic Library Integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/basic_library_integration.html#margin-environment-lifecycle">Margin Environment Lifecycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/basic_library_integration.html#data-lifecycle">Data Lifecycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/quick_start/basic_library_integration.html#third-party-libraries">Third-Party Libraries</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/quick_start/advanced_library_integration.html">Advanced Library Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../standalone/overview/toc.html">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../overview/features.html">Features</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../overview/features.html#margin-methodologies">Margin Methodologies</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/features.html#product-scope">Product Scope</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/features.html#outputs">Outputs</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/overview/system_requirements.html">System Requirements</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/overview/system_requirements.html#software">Software</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/overview/system_requirements.html#hardware">Hardware</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/overview/release_notes.html">Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../overview/known_limitations.html">Known Limitations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../overview/known_limitations.html#general">General</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/known_limitations.html#etd">ETD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/known_limitations.html#otc">OTC</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/overview/faq.html">Frequently Asked Questions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/overview/faq.html#system-requirements">System Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/overview/faq.html#market-data">Market Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/overview/faq.html#trades-and-positions">Trades and Positions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/overview/faq.html#margin-calculation">Margin Calculation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../standalone/data/toc.html">Input Data</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/data/trade_parsers.html">Portfolio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../trade_parsers/eurex_etd_csv.html">Eurex ETD CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trade_parsers/eurex_otc_csv.html">Eurex OTC CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trade_parsers/eurex_sensitivities_csv.html">Eurex Sensitivities CSV</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trade_parsers/fpml.html">FpML</a></li>
<li class="toctree-l3"><a class="reference internal" href="../trade_parsers/fixml.html">FIXML</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data/eurex_market_data.html">Market Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data/eurex_market_data.html#otc-requirements">OTC Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data/eurex_market_data.html#etd-requirements">ETD Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data/eurex_market_data.html#cross-margining-requirements">Cross-Margining Requirements</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data/fixings.html">Fixings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data/fixings.html#format">Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data/fixings.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data/holidays.html">Holidays</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data/holidays.html#format">Format</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data/holidays.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../data/standard_directory_structure.html">Standard Directory Structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../data/standard_directory_structure.html#directory-layout">Directory Layout</a></li>
<li class="toctree-l3"><a class="reference internal" href="../data/standard_directory_structure.html#individual-file-conventions">Individual File Conventions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../../standalone/integration/toc.html">Integration</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../standalone/integration/architecture.html">Library Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="loading_market_data.html">Loading Market Data</a><ul>
<li class="toctree-l3"><a class="reference internal" href="loading_market_data.html#automatic-file-resolution">Automatic file resolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="loading_market_data.html#explicit-usage">Explicit usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="loading_market_data.html#error-handling-during-loading">Error handling during loading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="loading_portfolios.html">Loading Portfolios</a><ul>
<li class="toctree-l3"><a class="reference internal" href="loading_portfolios.html#error-handling-during-loading">Error handling during loading</a></li>
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Performing Calculations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#trade-requests">Trade Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#portfolio-requests">Portfolio Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="#add-ons">Add-ons</a></li>
<li class="toctree-l3"><a class="reference internal" href="#portfolio-im">Portfolio IM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-a-request">Building a request</a></li>
<li class="toctree-l3"><a class="reference internal" href="#p-l-calculation-methodology">P&amp;L calculation methodology</a></li>
<li class="toctree-l3"><a class="reference internal" href="#output-model">Output Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-handling-during-calculation">Error handling during calculation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../overview/calculation_modes.html">Calculation Modes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../overview/calculation_modes.html#full-revaluation">Full Revaluation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overview/calculation_modes.html#delta-approximation">Delta Approximation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/integration/margin_results.html">Margin Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/integration/margin_results.html#portfolio-results">Portfolio Results</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/integration/margin_results.html#trade-results">Trade Results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/integration/concurrency.html">Concurrency</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/integration/concurrency.html#cpu-utilization">CPU utilization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/integration/concurrency.html#custom-executor-service">Custom Executor Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/integration/concurrency.html#concurrent-use-of-the-api">Concurrent use of the API</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/integration/common_tasks.html">Common Tasks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/integration/common_tasks.html#what-if-analysis">What-If Analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/integration/common_tasks.html#multiple-days-of-market-data">Multiple Days of Market Data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../standalone/integration/common_tasks.html#log-configuration">Log Configuration</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../standalone/advanced/toc.html">Advanced Topics</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/advanced/trade_model.html">Trade Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../standalone/advanced/third_party_dependencies.html">Third-Party Dependencies</a></li>
</ul>
</li>
</ul>

            
          </section>
        </div>

        <main id="main" class="main">
          
  <div class="section" id="performing-calculations">
<h1>Performing Calculations</h1>
<div class="section" id="trade-requests">
<h2>Trade Requests</h2>
<p>A request for trade present value can be built as such:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">TradeMeasure</span> <span class="n">pv</span> <span class="o">=</span> <span class="n">EurexPrismaRatesReplicationRequests</span><span class="o">.</span><span class="na">tradeMeasures</span><span class="o">()</span>
                                             <span class="o">.</span><span class="na">pv</span><span class="o">()</span>
                                             <span class="o">.</span><span class="na">currency</span><span class="o">(</span><span class="n">MarginCurrency</span><span class="o">.</span><span class="na">TRADE</span><span class="o">)</span>
                                             <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>Which can be added as:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">EurexPrismaRatesReplicationRequest</span> <span class="n">pvRequest</span> <span class="o">=</span> <span class="n">EurexPrismaRatesReplicationRequests</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">valuationDate</span><span class="o">)</span>
                                                                  <span class="o">.</span><span class="na">tradeMeasures</span><span class="o">(</span><span class="n">pv</span><span class="o">)</span>
                                                                  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="portfolio-requests">
<h2>Portfolio Requests</h2>
<p>The following details the mechanisms for building up a Eurex Prisma Replication request for computation of Initial Margin and the various constituent add-ons required to fully replicate the margin process. See the Eurex Clearing documentation for details on the methodology.</p>
</div>
<div class="section" id="add-ons">
<h2>Add-ons</h2>
<p>The following add-ons are automatically returned for a portfolio request:</p>
<p><strong>Correlation Break Adjustment</strong></p>
<p>There is a Correlation Break Adjustment applied to each sub series (Eurex defines no adjustment for stress scenarios so they will return 0).</p>
<p><strong>Liquidity addons</strong></p>
<p>A liquidity addon is applied based on the costs of a hedging portfolio.</p>
<p><strong>Compression Model Adjustment</strong></p>
<p>There is a Compression Model Adjustment applied to each sub series.</p>
<p><strong>Long Option Credit</strong></p>
<p>Provides any adjustments/credit for long options for each sub series.</p>
</div>
<div class="section" id="portfolio-im">
<h2>Portfolio IM</h2>
<p>The portfolio IM is based on the <strong>im</strong> <code class="docutils literal"><span class="pre">PortfolioMeasure</span></code>:</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">PortfolioMeasure</span> <span class="n">im</span> <span class="o">=</span> <span class="n">EurexPrismaReplicationRequests</span><span class="o">.</span><span class="na">portfolioMeasures</span><span class="o">().</span><span class="na">im</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="building-a-request">
<h2>Building a request</h2>
<p>The above portfolio measure is then added to a EurexPrismaReplicationRequest.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">EurexPrismaReplicationRequest</span> <span class="n">imRequest</span> <span class="o">=</span> <span class="n">EurexPrismaReplicationRequests</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">businessDate</span><span class="o">)</span>
                                                                        <span class="o">.</span><span class="na">portfolioMeasures</span><span class="o">(</span><span class="n">im</span><span class="o">)</span>
                                                                        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="p-l-calculation-methodology">
<h2>P&amp;L calculation methodology</h2>
<p>By default, the P&amp;L series is calculated by calculating the PV for each trade for each scenario and comparing to the base PV. It is also
possible to generate the P&amp;L series by using the sensitivity profile (bucketed delta only at this point) applied to
the scenarios provided by the clearing house.</p>
<p>See <a class="reference internal" href="../overview/calculation_modes.html"><em>Calculation Modes</em></a> for more information on which modes are available</p>
<div class="highlight-java"><div class="highlight"><pre><span class="n">EurexPrismaReplicationRequest</span> <span class="n">imRequest</span> <span class="o">=</span> <span class="n">EurexPrismaReplicationRequests</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">businessDate</span><span class="o">)</span>
                                                                        <span class="o">.</span><span class="na">portfolioMeasures</span><span class="o">(</span><span class="n">im</span><span class="o">)</span>
                                                                        <span class="o">.</span><span class="na">pnlCalculatorMethodology</span><span class="o">(</span><span class="n">PnlCalculatorMethodology</span><span class="o">.</span><span class="na">DELTA</span><span class="o">)</span>
                                                                        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
</div>
<div class="section" id="output-model">
<h2>Output Model</h2>
<p>Once market data and the portfolio have been loaded and the user has submitted a <code class="docutils literal"><span class="pre">EurexPrismaReplicationRequest</span></code>,
the engine will begin calculation or trade level and portfolio measures.</p>
<p>The user receives a <code class="docutils literal"><span class="pre">MarginResults</span></code> object back from the calculation.
Within this object are the <code class="docutils literal"><span class="pre">MarginPortfolioResults</span></code> and the <code class="docutils literal"><span class="pre">MarginTradeResults</span></code>.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">private</span> <span class="n">MarginResults</span> <span class="nf">calculateResults</span><span class="o">(</span><span class="n">MarginEnvironment</span> <span class="n">environment</span><span class="o">,</span>
    <span class="n">EurexPrismaReplicationRequest</span> <span class="n">request</span><span class="o">,</span>
    <span class="n">MarginPortfolio</span> <span class="n">marginPortfolio</span><span class="o">)</span> <span class="o">{</span>

  <span class="n">MarginCalculator</span> <span class="n">calculator</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="na">getMarginCalculator</span><span class="o">();</span>
  <span class="k">return</span> <span class="n">calculator</span><span class="o">.</span><span class="na">calculate</span><span class="o">(</span><span class="n">marginPortfolio</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>
</div>
<p>(see <a class="reference internal" href="../../standalone/integration/margin_results.html#margin-results"><span>Margin Results</span></a> for more information on the output)</p>
</div>
<div class="section" id="error-handling-during-calculation">
<h2>Error handling during calculation</h2>
<p>If there are runtime problems in valuing trades within the portfolio (for example a missing rate reset,
curve or price), the errors will be collected and reported back in the final results.
The <code class="docutils literal"><span class="pre">MarginPortfolioResults</span></code> contains a Table with any failures per trade and trade measure.</p>
<p>Because these trades could not be successfully valued, they do not contribute to the overall portfolio level
measures. It is therefore critical to inspect the <code class="docutils literal"><span class="pre">MarginPortfolioResults.getPortfolioResults().getTradeErrors()</span></code>.
It will be empty if there are no errors, but if values are present they should be investigate to ensure that the
portfolio is properly analyzed.</p>
<div class="section" id="trade-level-failures-in-the-results">
<h3>Trade level failures in the results</h3>
<p>The code below shows how one could iterate over any tradeErrors present on the portfolio results.</p>
<div class="highlight-java"><div class="highlight"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">noteAnyInvalidTrades</span><span class="o">(</span><span class="n">MarginResults</span> <span class="n">marginResults</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">MarginPortfolioResults</span> <span class="n">portfolioResults</span> <span class="o">=</span> <span class="n">marginResults</span><span class="o">.</span><span class="na">getPortfolioResults</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">portfolioResults</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Table</span><span class="o">&lt;</span><span class="n">TradeWrapper</span><span class="o">&lt;?&gt;,</span> <span class="n">TradeMeasure</span><span class="o">,</span> <span class="n">Result</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">table</span> <span class="o">=</span> <span class="n">portfolioResults</span><span class="o">.</span><span class="na">getTradeErrors</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="n">TradeWrapper</span><span class="o">&lt;?&gt;</span> <span class="n">trade</span> <span class="o">:</span> <span class="n">table</span><span class="o">.</span><span class="na">rowKeySet</span><span class="o">())</span> <span class="o">{</span>
      <span class="k">for</span> <span class="o">(</span><span class="n">TradeMeasure</span> <span class="n">measure</span> <span class="o">:</span> <span class="n">table</span><span class="o">.</span><span class="na">columnKeySet</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">Result</span><span class="o">&lt;?&gt;</span> <span class="n">failure</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">trade</span><span class="o">,</span> <span class="n">measure</span><span class="o">);</span>
        <span class="n">s_logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&quot;Found trade failure: &quot;</span> <span class="o">+</span> <span class="n">failure</span><span class="o">.</span><span class="na">getFailureMessage</span><span class="o">());</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="specific-failure-cases">
<h3>Specific failure cases</h3>
<p>A common case, for example, would be a missing reset. In this case the code above would produce an
error message along the lines of:</p>
<div class="highlight-python"><div class="highlight"><pre>WARN  c.o.m.e.prisma.cli.common.CliLogger -
Found trade failure: No time series data available for RawId{id=Bundle[ISDA~USD-LIBOR-BBA-3M],
marketDataType=class java.lang.Double, fieldName=Market_Value}/[2014-06-03,2015-06-09]
</pre></div>
</div>
<p>This would tell the user that there was a missing 3M USD LIBOR fixing in the data.</p>
</div>
</div>
</div>


        </main>
      </div>

      <footer>
  <div class="row">
    <div class="small-6 columns"><p>Version 1.8.3</p></div>
    <div class="small-6 columns"><p class="copyright">&copy; 2015 OpenGamma Limited</p></div>
  </div>
</footer>
    </div>
  </body>
</html>
